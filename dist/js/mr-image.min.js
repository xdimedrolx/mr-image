var app=angular.module("mrImage",[]);app.directive("mrImage",function(){return{restrict:"A",scope:{src:"=mrSrc",maxWidth:"=?mrMaxWidth",realCoords:"=?mrRealCoords",aspectRatio:"=?mrAspectRatio",scale:"=?mrScale",drawer:"=?mrDrawer",selector:"=?mrSelector"},template:'<div mr-image-selector mr-model="selector" mr-real-coords="realCoords" mr-aspect-ratio="aspectRatio" style="height: {{scaleValue(height, scale) + \'px\'}}; width: {{scaleValue(width, scale) + \'px\'}}"></div><div mr-image-drawer mr-model="drawer" style="height: {{scaleValue(height, scale) + \'px\'}}; width: {{scaleValue(width, scale) + \'px\'}}"></div><img ng-src="{{src}}" width="{{scaleValue(width, scale)}}" height="{{scaleValue(height, scale)}}">',controller:function(a){a.image=new Image,a.setLoadedCallback=function(b){a.loadedCallback=b}},link:function(a,b){function c(c){a.image.onload=function(){a.$apply(function(){a.height=a.height||a.image.height,a.width=a.width||a.image.width,a.scale=angular.isUndefined(a.scale)&&angular.isDefined(a.maxWidth)?a.maxWidth>=a.width?1:a.maxWidth/a.width:a.scale||1,b.css("width",a.scaleValue(a.width,a.scale)+"px"),b.css("height",a.scaleValue(a.height,a.scale)+"px")}),angular.isFunction(a.loadedCallback)&&a.loadedCallback()},a.image.src=c}b.addClass("mr-image"),c(a.src),a.scaleValue=function(a,b){return Math.floor(a*b)}}}}),app.directive("mrImageDrawer",function(){return{restrict:"A",scope:{rects:"=mrModel"},template:"<div ng-repeat=\"rect in rects\" style=\"position: absolute;cursor: pointer;top:    {{ rect.y1 }}px;left:   {{ rect.x1 }}px;width:  {{ (rect.x2 - rect.x1)}}px;height: {{ (rect.y2 - rect.y1)}}px;border: {{ rect.stroke || 3 }}px solid {{ rect.color || '#F00' }};background-color: {{ increaseBrightness(rect.color || '#F00', '0.3') }}\"ng-style='rectStyle'ng-mouseenter=\"rectStyle = { 'background-color': increaseBrightness(rect.color || '#F00', '0.1') }\"ng-mouseout=\"rectStyle =   { 'background-color': increaseBrightness(rect.color || '#F00', '0.3' ) }\"></div>",link:function(a){a.increaseBrightness=function(a,b){a=a.replace(/^\s*#|\s*$/g,""),3==a.length&&(a=a.replace(/(.)/g,"$1$1"));var c=parseInt(a.substr(0,2),16),d=parseInt(a.substr(2,2),16),e=parseInt(a.substr(4,2),16);return"rgba("+c+","+d+","+e+","+b+")"}}}}),app.directive("mrImageSelector",function(){function a(a){var b,c={top:0,left:0},d=a&&a[0].ownerDocument;return b=d.documentElement,void 0!==typeof a[0].getBoundingClientRect&&(c=a[0].getBoundingClientRect()),{top:c.top+(window.pageYOffset||b.scrollTop)-(b.clientTop||0),left:c.left+(window.pageXOffset||b.scrollLeft)-(b.clientLeft||0)}}return{restrict:"A",scope:{selector:"=?mrModel",realCoords:"=?mrRealCoords",src:"=?mrSrc",aspectRatio:"=?mrAspectRatio"},link:function(b,c){function d(a,b,c){P.css("display","block"),Q.css("right",b-a.left+"px"),T.css("left",b-a.right+"px"),R.css("left",a.left+"px"),R.css("right",a.right+"px"),R.css("bottom",c-a.top+"px"),S.css("left",a.left+"px"),S.css("right",a.right+"px"),S.css("top",c-a.bottom+"px")}function e(){L[0].documentElement.className=L[0].documentElement.className.replace(" mr-user-select","")}function f(){L[0].documentElement.className+=" mr-user-select"}function g(){L.bind("mousemove",j),L.bind("mouseup",k)}function h(){L.unbind("mousemove",j),L.unbind("mouseup",k)}function i(b){f();var d=a(c);U=b.pageX-d.left,V=b.pageY-d.top,W=!0,g()}function j(d){W=!1;var e=a(c),f=d.pageX-e.left,g=d.pageY-e.top;b.$apply(function(){l(U,V,f,g)})}function k(){e(),W&&b.$apply(z),h()}function l(a,b,d,e){var f=c.css("height").replace("px",""),g=c.css("width").replace("px","");d=0>d?0:d,d=d>g?g:d,e=0>e?0:e,e=e>f?f:e;var h={top:e>b?b:e,bottom:e>b?f-e:f-b,left:d>a?a:d,right:d>a?g-d:g-a};w(h,g,f)}function m(){L.bind("mousemove",p),L.bind("mouseup",q)}function n(){L.unbind("mousemove",p),L.unbind("mouseup",q)}function o(a){a.stopPropagation(),f(),$=angular.element(a.target).attr("class").replace("mr-drag-handle","").replace("mr-drag-line","").trim(),X=a.pageX,Y=a.pageY,Z={top:parseInt(M.css("top")),bottom:parseInt(M.css("bottom")),left:parseInt(M.css("left")),right:parseInt(M.css("right"))},m()}function p(a){var d=c.css("height").replace("px",""),e=c.css("width").replace("px",""),f=a.pageX-X,g=a.pageY-Y,h={top:Z.top,bottom:Z.bottom,left:Z.left,right:Z.right};"n"==$[0]?h.top+=g:"s"==$[0]&&(h.bottom-=g),"w"==$[0]||"w"==$[1]?h.left+=f:("e"==$[0]||"e"==$[1])&&(h.right-=f);var i;(h.top>=d-h.bottom||h.bottom>=d-h.top)&&(i=h.top,h.top=d-h.bottom,h.bottom=d-i),(h.left>=e-h.right||h.right>=e-h.left)&&(i=h.left,h.left=e-h.right,h.right=e-i),h.top=h.top<0?0:h.top,h.bottom=h.bottom<0?0:h.bottom,h.left=h.left<0?0:h.left,h.right=h.right<0?0:h.right,K&&("n"==$&&(h.left=e-(h.right+(d-h.top-h.bottom)*K)),"s"==$&&(h.right=e-(h.left+(d-h.top-h.bottom)*K)),("w"==$||"nw"==$||"ne"==$)&&(h.top=d-(h.bottom+(e-h.left-h.right)/K),h.top<0&&(h.top=0,"w"==$[0]||"w"==$[1]?h.left=e-(h.right+(d-h.top-h.bottom)*K):h.right=e-(h.left+(d-h.top-h.bottom)*K))),("e"==$||"se"==$||"sw"==$)&&(h.bottom=d-(h.top+(e-h.left-h.right)/K),h.bottom<0&&(h.bottom=0,"e"==$[0]||"e"==$[1]?h.right=e-(h.left+(d-h.top-h.bottom)*K):h.left=e-(h.right+(d-h.top-h.bottom)*K)))),b.$apply(function(){w(h,e,d)})}function q(){e(),n()}function r(){L.bind("mousemove",u),L.bind("mouseup",v)}function s(){L.unbind("mousemove",u),L.unbind("mouseup",v)}function t(a){a.stopPropagation(),f(),X=a.pageX,Y=a.pageY,Z={top:parseInt(M.css("top")),bottom:parseInt(M.css("bottom")),left:parseInt(M.css("left")),right:parseInt(M.css("right"))},r()}function u(a){var d=c.css("height").replace("px",""),e=c.css("width").replace("px",""),f=a.pageX-X,g=a.pageY-Y,h={top:Z.top+g,bottom:Z.bottom-g,left:Z.left+f,right:Z.right-f};h.top<0&&(h.bottom=h.bottom+h.top,h.top=0),h.bottom<0&&(h.top=h.bottom+h.top,h.bottom=0),h.left<0&&(h.right=h.right+h.left,h.left=0),h.right<0&&(h.left=h.left+h.right,h.right=0),b.$apply(function(){w(h,e,d)})}function v(){e(),s()}function w(a,c,e){a&&(K&&(U>a.left?a.left=c-(a.right+(e-a.top-a.bottom)*K):a.right=c-(a.left+(e-a.top-a.bottom)*K),a.top<0&&(a.top=0,a.left=c-(a.right+(e-a.top-a.bottom)*K)),a.bottom<0&&(a.bottom=0,a.right=c-(a.left+(e-a.top-a.bottom)*K)),a.left<0&&(a.left=0,a.top=e-(a.bottom+(c-a.left-a.right)/K)),a.right<0&&(a.right=0,a.bottom=e-(a.top+(c-a.left-a.right)/K))),d(a,c,e),M.css("display","block"),M.css({top:a.top+"px",bottom:a.bottom+"px",left:a.left+"px",right:a.right+"px"}),aa(),J.x1=a.left,J.y1=a.top,J.x2=c-a.right,J.y2=e-a.bottom,b.realCoords=H(),aa=b.$watch("selector",D,!0))}function x(){_||(c.bind("mousedown",i),N.bind("mousedown",o),O.bind("mousedown",o),M.bind("mousedown",t),_=!0)}function y(){_&&(c.unbind("mousedown",i),N.unbind("mousedown",o),O.unbind("mousedown",o),M.unbind("mousedown",t),_=!1)}function z(){J.x1=J.x2=J.y1=J.y2=void 0,b.realCoords={},M.css("display","none"),P.css("display","none")}function A(){return angular.isUndefined(J.x1)&&angular.isUndefined(J.x2)&&angular.isUndefined(J.y1)&&angular.isUndefined(J.y2)}function B(a){return angular.isUndefined(a.x1)&&angular.isUndefined(a.x2)&&angular.isUndefined(a.y1)&&angular.isUndefined(a.y2)}function C(){return isFinite(J.x1)&&isFinite(J.x2)&&isFinite(J.y1)&&isFinite(J.y2)}function D(a,b){return E(a.enabled),angular.equals(a,b)||a.enabled!=b.enabled||A()?void 0:C()?void l(a.x1,a.y1,a.x2,a.y2):void console.error("[ERROR]: Selector position value (x1, x2, y1, y2) is not a valid number.")}function E(a){J.enabled="boolean"!=typeof a?!0:a,!J.enabled||!C()&&B(b.realCoords)?J.enabled?(x(),c.css("z-index",300),z()):(y(),c.css("z-index",100),M.css("display","none"),P.css("display","none")):(x(),c.css("z-index",300),M.css("display","block"),P.css("display","block"))}function F(){var a=document.createElement("canvas"),c=a.getContext("2d"),d=1/b.$parent.scale,e=(J.x2-J.x1)*d,f=(J.y2-J.y1)*d;return a.width=e,a.height=f,c.drawImage(b.$parent.image,J.x1*d,J.y1*d,e,f,0,0,e,f),a.toDataURL("image/png")}function G(a){var d=b.$parent.image.naturalHeight,e=b.$parent.image.naturalWidth,f=c.css("height").replace("px",""),g=c.css("width").replace("px","");angular.isUndefined(a.x2)&&(a.x2=e),angular.isUndefined(a.y2)&&(a.y2=d),a.x1=Math.round(a.x1*g/e),a.x2=Math.round(a.x2*g/e),a.y1=Math.round(a.y1*f/d),a.y2=Math.round(a.y2*f/d),l(a.x1,a.y1,a.x2,a.y2)}function H(){var a=b.$parent.image.naturalHeight,d=b.$parent.image.naturalWidth,e=c.css("height").replace("px",""),f=c.css("width").replace("px","");return{x1:Math.round(J.x1*d/f),y1:Math.round(J.y1*a/e),x2:Math.round(J.x2*d/f),y2:Math.round(J.y2*a/e)}}function I(){J.enabled&&b.$apply(function(){G(b.realCoords)})}b.selector=b.selector||{enabled:!0},b.realCoords=b.realCoords||{},B(b.realCoords)&&(b.realCoords={x1:0,y1:0});var J=b.selector,K=b.aspectRatio;b.$watch("aspectRatio",function(a){K=a});var L=angular.element(document),M=angular.element('<div class="mr-box"><div class="mr-line top"></div><div class="mr-line bottom"></div><div class="mr-line left"></div><div class="mr-line right"></div></div>'),N=angular.element('<div class="mr-drag-line n"></div><div class="mr-drag-line s"></div><div class="mr-drag-line w"></div><div class="mr-drag-line e"></div>'),O=angular.element('<div class="mr-drag-handle nw"></div><div class="mr-drag-handle n"></div><div class="mr-drag-handle ne"></div><div class="mr-drag-handle w"></div><div class="mr-drag-handle e"></div><div class="mr-drag-handle sw"></div><div class="mr-drag-handle s"></div><div class="mr-drag-handle se"></div>');M.append(N).append(O),c.append(M);var P=angular.element('<div class="mr-shadow">'),Q=angular.element('<div class="mr-shadow left">'),R=angular.element('<div class="mr-shadow center top">'),S=angular.element('<div class="mr-shadow center bottom">'),T=angular.element('<div class="mr-shadow right">');P.append(Q).append(R).append(S).append(T),c.append(P);var U,V,W=!1;c.bind("mousedown",i);var X,Y,Z,$;N.bind("mousedown",o),O.bind("mousedown",o),M.bind("mousedown",t);var _=!0;J.clear=z,J.enabled="boolean"!=typeof J.enabled?!0:J.enabled;var aa=b.$watch("selector",D,!0);J.crop=F,J.setRealCoords=G,J.getRealCoords=H;var ba=angular.element(b.$parent.image);ba[0].complete&&ba[0].naturalWidth>0?(console.log("load image from cache"),I()):b.$parent.setLoadedCallback(I.bind(this))}}});