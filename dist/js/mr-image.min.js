var app=angular.module("mrImage",[]);app.directive("mrImage",function(){return{restrict:"A",scope:{src:"=mrSrc",maxWidth:"=?mrMaxWidth",aspectRatio:"=?mrAspectRatio",scale:"=?mrScale",drawer:"=?mrDrawer",selector:"=?mrSelector"},template:'<div mr-image-selector mr-model="selector" mr-aspect-ratio="aspectRatio" style="height: {{scaleValue(height, scale) + \'px\'}}; width: {{scaleValue(width, scale) + \'px\'}}"></div><div mr-image-drawer mr-model="drawer" style="height: {{scaleValue(height, scale) + \'px\'}}; width: {{scaleValue(width, scale) + \'px\'}}"></div><img ng-src="{{src}}" width="{{scaleValue(width, scale)}}" height="{{scaleValue(height, scale)}}">',link:function(a,b){function c(c){a.image=new Image,a.image.onload=function(){a.$apply(function(){a.height=a.height||a.image.height,a.width=a.width||a.image.width,a.scale=angular.isUndefined(a.scale)&&angular.isDefined(a.maxWidth)?a.maxWidth>=a.width?1:a.maxWidth/a.width:a.scale||1,b.css("width",a.scaleValue(a.width,a.scale)+"px"),b.css("height",a.scaleValue(a.height,a.scale)+"px")})},a.image.src=c}b.addClass("mr-image"),c(a.src),a.scaleValue=function(a,b){return Math.floor(a*b)}}}}),app.directive("mrImageDrawer",function(){return{restrict:"A",scope:{rects:"=mrModel"},template:"<div ng-repeat=\"rect in rects\" style=\"position: absolute;cursor: pointer;top:    {{ rect.y1 }}px;left:   {{ rect.x1 }}px;width:  {{ (rect.x2 - rect.x1)}}px;height: {{ (rect.y2 - rect.y1)}}px;border: {{ rect.stroke || 3 }}px solid {{ rect.color || '#F00' }};background-color: {{ increaseBrightness(rect.color || '#F00', '0.3') }}\"ng-style='rectStyle'ng-mouseenter=\"rectStyle = { 'background-color': increaseBrightness(rect.color || '#F00', '0.1') }\"ng-mouseout=\"rectStyle =   { 'background-color': increaseBrightness(rect.color || '#F00', '0.3' ) }\"></div>",link:function(a){a.increaseBrightness=function(a,b){a=a.replace(/^\s*#|\s*$/g,""),3==a.length&&(a=a.replace(/(.)/g,"$1$1"));var c=parseInt(a.substr(0,2),16),d=parseInt(a.substr(2,2),16),e=parseInt(a.substr(4,2),16);return"rgba("+c+","+d+","+e+","+b+")"}}}}),app.directive("mrImageSelector",function(){function a(a){var b,c={top:0,left:0},d=a&&a[0].ownerDocument;return b=d.documentElement,void 0!==typeof a[0].getBoundingClientRect&&(c=a[0].getBoundingClientRect()),{top:c.top+(window.pageYOffset||b.scrollTop)-(b.clientTop||0),left:c.left+(window.pageXOffset||b.scrollLeft)-(b.clientLeft||0)}}return{restrict:"A",scope:{selector:"=?mrModel",src:"=?mrSrc",aspectRatio:"=?mrAspectRatio"},link:function(b,c){function d(a,b,c){O.css("display","block"),P.css("right",b-a.left+"px"),S.css("left",b-a.right+"px"),Q.css("left",a.left+"px"),Q.css("right",a.right+"px"),Q.css("bottom",c-a.top+"px"),R.css("left",a.left+"px"),R.css("right",a.right+"px"),R.css("top",c-a.bottom+"px")}function e(){K[0].documentElement.className=K[0].documentElement.className.replace(" mr-user-select","")}function f(){K[0].documentElement.className+=" mr-user-select"}function g(){K.bind("mousemove",j),K.bind("mouseup",k)}function h(){K.unbind("mousemove",j),K.unbind("mouseup",k)}function i(b){f();var d=a(c);T=b.pageX-d.left,U=b.pageY-d.top,V=!0,g()}function j(d){V=!1;var e=a(c),f=d.pageX-e.left,g=d.pageY-e.top;b.$apply(function(){l(T,U,f,g)})}function k(){e(),V&&b.$apply(z),h()}function l(a,b,d,e){var f=c.css("height").replace("px",""),g=c.css("width").replace("px","");d=0>d?0:d,d=d>g?g:d,e=0>e?0:e,e=e>f?f:e;var h={top:e>b?b:e,bottom:e>b?f-e:f-b,left:d>a?a:d,right:d>a?g-d:g-a};w(h,g,f)}function m(){K.bind("mousemove",p),K.bind("mouseup",q)}function n(){K.unbind("mousemove",p),K.unbind("mouseup",q)}function o(a){a.stopPropagation(),f(),Z=angular.element(a.target).attr("class").replace("mr-drag-handle","").replace("mr-drag-line","").trim(),W=a.pageX,X=a.pageY,Y={top:parseInt(L.css("top")),bottom:parseInt(L.css("bottom")),left:parseInt(L.css("left")),right:parseInt(L.css("right"))},m()}function p(a){var d=c.css("height").replace("px",""),e=c.css("width").replace("px",""),f=a.pageX-W,g=a.pageY-X,h={top:Y.top,bottom:Y.bottom,left:Y.left,right:Y.right};"n"==Z[0]?h.top+=g:"s"==Z[0]&&(h.bottom-=g),"w"==Z[0]||"w"==Z[1]?h.left+=f:("e"==Z[0]||"e"==Z[1])&&(h.right-=f);var i;(h.top>=d-h.bottom||h.bottom>=d-h.top)&&(i=h.top,h.top=d-h.bottom,h.bottom=d-i),(h.left>=e-h.right||h.right>=e-h.left)&&(i=h.left,h.left=e-h.right,h.right=e-i),h.top=h.top<0?0:h.top,h.bottom=h.bottom<0?0:h.bottom,h.left=h.left<0?0:h.left,h.right=h.right<0?0:h.right,J&&("n"==Z&&(h.left=e-(h.right+(d-h.top-h.bottom)*J)),"s"==Z&&(h.right=e-(h.left+(d-h.top-h.bottom)*J)),("w"==Z||"nw"==Z||"ne"==Z)&&(h.top=d-(h.bottom+(e-h.left-h.right)/J),h.top<0&&(h.top=0,"w"==Z[0]||"w"==Z[1]?h.left=e-(h.right+(d-h.top-h.bottom)*J):h.right=e-(h.left+(d-h.top-h.bottom)*J))),("e"==Z||"se"==Z||"sw"==Z)&&(h.bottom=d-(h.top+(e-h.left-h.right)/J),h.bottom<0&&(h.bottom=0,"e"==Z[0]||"e"==Z[1]?h.right=e-(h.left+(d-h.top-h.bottom)*J):h.left=e-(h.right+(d-h.top-h.bottom)*J)))),b.$apply(function(){w(h,e,d)})}function q(){e(),n()}function r(){K.bind("mousemove",u),K.bind("mouseup",v)}function s(){K.unbind("mousemove",u),K.unbind("mouseup",v)}function t(a){a.stopPropagation(),f(),W=a.pageX,X=a.pageY,Y={top:parseInt(L.css("top")),bottom:parseInt(L.css("bottom")),left:parseInt(L.css("left")),right:parseInt(L.css("right"))},r()}function u(a){var d=c.css("height").replace("px",""),e=c.css("width").replace("px",""),f=a.pageX-W,g=a.pageY-X,h={top:Y.top+g,bottom:Y.bottom-g,left:Y.left+f,right:Y.right-f};h.top<0&&(h.bottom=h.bottom+h.top,h.top=0),h.bottom<0&&(h.top=h.bottom+h.top,h.bottom=0),h.left<0&&(h.right=h.right+h.left,h.left=0),h.right<0&&(h.left=h.left+h.right,h.right=0),b.$apply(function(){w(h,e,d)})}function v(){e(),s()}function w(a,c,e){a&&(J&&(T>a.left?a.left=c-(a.right+(e-a.top-a.bottom)*J):a.right=c-(a.left+(e-a.top-a.bottom)*J),a.top<0&&(a.top=0,a.left=c-(a.right+(e-a.top-a.bottom)*J)),a.bottom<0&&(a.bottom=0,a.right=c-(a.left+(e-a.top-a.bottom)*J)),a.left<0&&(a.left=0,a.top=e-(a.bottom+(c-a.left-a.right)/J)),a.right<0&&(a.right=0,a.bottom=e-(a.top+(c-a.left-a.right)/J))),d(a,c,e),L.css("display","block"),L.css({top:a.top+"px",bottom:a.bottom+"px",left:a.left+"px",right:a.right+"px"}),_(),I.x1=a.left,I.y1=a.top,I.x2=c-a.right,I.y2=e-a.bottom,_=b.$watch("selector",C,!0))}function x(){$||(c.bind("mousedown",i),M.bind("mousedown",o),N.bind("mousedown",o),L.bind("mousedown",t),$=!0)}function y(){$&&(c.unbind("mousedown",i),M.unbind("mousedown",o),N.unbind("mousedown",o),L.unbind("mousedown",t),$=!1)}function z(){I.x1=I.x2=I.y1=I.y2=void 0,L.css("display","none"),O.css("display","none")}function A(){return angular.isUndefined(I.x1)&&angular.isUndefined(I.x2)&&angular.isUndefined(I.y1)&&angular.isUndefined(I.y2)}function B(){return isFinite(I.x1)&&isFinite(I.x2)&&isFinite(I.y1)&&isFinite(I.y2)}function C(a,b){return D(a.enabled),angular.equals(a,b)||a.enabled!=b.enabled||A()?void 0:B()?void l(a.x1,a.y1,a.x2,a.y2):void console.error("[ERROR]: Selector position value (x1, x2, y1, y2) is not a valid number.")}function D(a){I.enabled="boolean"!=typeof a?!0:a,I.enabled&&B()?(x(),c.css("z-index",300),L.css("display","block"),O.css("display","block")):I.enabled?(x(),c.css("z-index",300),z()):(y(),c.css("z-index",100),L.css("display","none"),O.css("display","none"))}function E(){var a=document.createElement("canvas"),c=a.getContext("2d"),d=1/b.$parent.scale,e=(I.x2-I.x1)*d,f=(I.y2-I.y1)*d;return a.width=e,a.height=f,c.drawImage(b.$parent.image,I.x1*d,I.y1*d,e,f,0,0,e,f),a.toDataURL("image/png")}function F(a){var d=b.$parent.image.naturalHeight,e=b.$parent.image.naturalWidth,f=c.css("height").replace("px",""),g=c.css("width").replace("px","");a.x1=Math.round(a.x1*g/e),a.x2=Math.round(a.x2*g/e),a.y1=Math.round(a.y1*f/d),a.y2=Math.round(a.y2*f/d),l(a.x1,a.y1,a.x2,a.y2)}function G(){var a=b.$parent.image.naturalHeight,d=b.$parent.image.naturalWidth,e=c.css("height").replace("px",""),f=c.css("width").replace("px","");return{x1:Math.round(I.x1*d/f),y1:Math.round(I.y1*a/e),x2:Math.round(I.x2*d/f),y2:Math.round(I.y2*a/e)}}function H(a){var c=angular.element(b.$parent.image);c.on("load",function(){F(a)})}b.selector=b.selector||{};var I=b.selector,J=b.aspectRatio;b.$watch("aspectRatio",function(a){J=a});var K=angular.element(document),L=angular.element('<div class="mr-box"><div class="mr-line top"></div><div class="mr-line bottom"></div><div class="mr-line left"></div><div class="mr-line right"></div></div>'),M=angular.element('<div class="mr-drag-line n"></div><div class="mr-drag-line s"></div><div class="mr-drag-line w"></div><div class="mr-drag-line e"></div>'),N=angular.element('<div class="mr-drag-handle nw"></div><div class="mr-drag-handle n"></div><div class="mr-drag-handle ne"></div><div class="mr-drag-handle w"></div><div class="mr-drag-handle e"></div><div class="mr-drag-handle sw"></div><div class="mr-drag-handle s"></div><div class="mr-drag-handle se"></div>');L.append(M).append(N),c.append(L);var O=angular.element('<div class="mr-shadow">'),P=angular.element('<div class="mr-shadow left">'),Q=angular.element('<div class="mr-shadow center top">'),R=angular.element('<div class="mr-shadow center bottom">'),S=angular.element('<div class="mr-shadow right">');O.append(P).append(Q).append(R).append(S),c.append(O);var T,U,V=!1;c.bind("mousedown",i);var W,X,Y,Z;M.bind("mousedown",o),N.bind("mousedown",o),L.bind("mousedown",t);var $=!0;I.clear=z,I.enabled="boolean"!=typeof I.enabled?!0:I.enabled;var _=b.$watch("selector",C,!0);I.crop=E,I.setRealCoords=F,I.getRealCoords=G,I.enabled&&setTimeout(function(){I.realCoords||(I.realCoords={x1:0,y1:0,x2:Number.MAX_VALUE,y2:Number.MAX_VALUE}),H(I.realCoords)},0)}}});